<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>لوحة التحكم - التسجيلات</title>
<style>
  *{box-sizing:border-box}
  body{font-family:Arial,sans-serif;background:#f6f7fb;margin:0;padding:24px}
  .wrap{max-width:1200px;margin:0 auto}
  .card{background:#fff;border-radius:16px;padding:22px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
  h2{margin:0 0 14px;text-align:center}
  .muted{color:#666;text-align:center;margin:0 0 16px}
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
  .stat{background:#fafafa;border:1px solid #eee;border-radius:14px;padding:14px}
  .stat .k{color:#666;font-size:13px;margin-bottom:6px}
  .stat .v{font-size:22px;font-weight:800}
  .two{grid-column:span 2}
  .full{grid-column:1/-1}

  input,select,button{width:100%;padding:12px;border-radius:12px;border:1px solid #ddd;font-size:15px}
  button{border:0;background:#2e7d32;color:#fff;cursor:pointer}
  button:hover{background:#256628}
  .btn-secondary{background:#6c63ff}
  .btn-secondary:hover{background:#5a52df}
  .btn-dark{background:#263238}
  .btn-dark:hover{background:#1f282c}
  .btn-gray{background:#9e9e9e}
  .btn-gray:hover{background:#8a8a8a}
  .btn-danger{background:#c62828}
  .btn-danger:hover{background:#a32020}

  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border-bottom:1px solid #eee;padding:10px;text-align:right;font-size:14px;vertical-align:top}
  th{background:#fafafa;position:sticky;top:0}
  .pill{display:inline-block;padding:3px 10px;border-radius:999px;background:#f1f1f1;font-size:12px}
  .msg{margin-top:12px;text-align:center;font-weight:700}
  .err{color:#b00020}
  .ok{color:#1b5e20}
  .row-muted{color:#666;font-size:12px;margin-top:4px}

  .sectionTitle{margin:18px 0 8px;font-size:18px}
  .actions{display:flex;gap:10px;flex-wrap:wrap}
  .actions > *{flex:1}

  .mini{padding:10px;border-radius:10px;font-size:14px}
  .btn-mini{padding:10px 12px;border-radius:10px;font-size:14px}

  .linkBtn{
    display:inline-block;
    padding:6px 10px;
    border-radius:10px;
    background:#f1f1f1;
    text-decoration:none;
    color:#111;
    font-size:12px;
    margin-left:6px;
    margin-bottom:6px;
    white-space:nowrap;
  }

  .lockPill{
    display:inline-block;
    padding:3px 10px;
    border-radius:999px;
    background:#ffe0b2;
    font-size:12px;
    color:#8a4b00;
    font-weight:700;
  }

  .toolbarLine{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-top:10px;
    align-items:center;
  }
  .toolbarLine > *{flex:1}
  .toolbarLine .tight{flex:0.6}
  .toolbarLine .wide{flex:1.4}

  .pager{
    display:flex;
    gap:10px;
    justify-content:center;
    margin-top:10px;
    flex-wrap:wrap;
  }
  .pager button{width:auto; min-width:160px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h2>لوحة التحكم (Dashboard)</h2>
    <p class="muted">إحصائيات + عرض الكل + بحث + فلترة + تعديل الدرجات والحالة + تغيير حالة جماعي + PDF + تصدير CSV (Excel)</p>
   <button type="button" onclick="printAllGuardiansPdf()">طباعة كشف PDF (حسب الصندوق)</button>

    <div class="grid">
      <!-- Admin key -->
      <div class="full">
        <label style="display:block;margin:0 0 8px;font-weight:700">Admin Key</label>
        <input id="admin_key" placeholder="اكتب المفتاح (ADMIN_KEY)" />
        <div class="actions" style="margin-top:10px">
          <button class="btn-secondary" type="button" onclick="loadStats()">تحديث الإحصائيات</button>
          <button class="btn-dark" type="button" onclick="saveKey()">حفظ المفتاح على الجهاز</button>
          <button type="button" onclick="exportCsv()">تصدير Excel (CSV)</button>
        </div>
        <div class="msg" id="msg"></div>
      </div>

      <!-- stats -->
      <div class="stat"><div class="k">إجمالي الصفوف (التسجيلات)</div><div class="v" id="total_rows">—</div></div>
      <div class="stat"><div class="k">بنين</div><div class="v" id="boys">—</div></div>
      <div class="stat"><div class="k">بنات</div><div class="v" id="girls">—</div></div>
      <div class="stat"><div class="k">الإجمالي (بنين+بنات)</div><div class="v" id="sum_bg">—</div></div>

      <div class="stat two"><div class="k">الروضة (KG)</div><div class="v" id="st_KG">—</div></div>
      <div class="stat two"><div class="k">الابتدائي (Primary)</div><div class="v" id="st_Primary">—</div></div>
      <div class="stat two"><div class="k">المتوسط (Middle)</div><div class="v" id="st_Middle">—</div></div>
      <div class="stat two"><div class="k">الثانوي (Secondary)</div><div class="v" id="st_Secondary">—</div></div>

      <!-- Filters + View all -->
      <div class="full">
        <div class="sectionTitle">عرض الكل + فلترة</div>

        <div class="toolbarLine">
          <select id="filter_stage" class="mini">
            <option value="">كل المراحل</option>
            <option value="KG">KG</option>
            <option value="Primary">Primary</option>
            <option value="Middle">Middle</option>
            <option value="Secondary">Secondary</option>
          </select>

          <select id="filter_gender" class="mini">
            <option value="">الكل (نوع)</option>
            <option value="Boys">Boys</option>
            <option value="Girls">Girls</option>
          </select>

          <select id="pageSize" class="mini tight">
            <option value="25">25</option>
            <option value="50" selected>50</option>
            <option value="100">100</option>
            <option value="200">200</option>
          </select>

          <button class="btn-secondary wide" type="button" onclick="loadAll(1)">عرض كل المسجلين</button>
        </div>

        <div class="row-muted" id="allInfo"></div>

        <div class="pager" id="pager" style="display:none">
          <button class="btn-gray" type="button" onclick="prevPage()">السابق</button>
          <button class="btn-gray" type="button" onclick="nextPage()">التالي</button>
        </div>
      </div>

      <!-- Search -->
      <div class="full">
        <div class="sectionTitle">بحث</div>
        <div class="actions">
          <select id="search_field" class="mini">
            <option value="child_civil_id">رقم مدني الطفل</option>
            <option value="guardian_civil_id">رقم مدني ولي الأمر</option>
            <option value="box_number">رقم الصندوق</option>
            <option value="reg_id">Reg ID</option>
          </select>
          <input id="search_q" class="mini" placeholder="اكتب قيمة البحث..." />
          <button class="btn-mini btn-secondary" type="button" onclick="doSearch()">بحث</button>
        </div>
        <div class="row-muted" id="searchInfo"></div>
      </div>

      <!-- Bulk status -->
      <div class="full">
        <div class="sectionTitle">تغيير حالة جماعي (على النتائج الحالية)</div>
        <div class="toolbarLine">
          <select id="bulk_status" class="mini">
            <option value="">اختر حالة</option>
            <option value="REGISTERED">REGISTERED</option>
            <option value="SUBMITTED">SUBMITTED</option>
            <option value="PASSED">PASSED</option>
            <option value="FAILED">FAILED</option>
            <option value="ABSENT">ABSENT</option>
          </select>
          <button class="btn-danger" type="button" onclick="bulkApply()">تطبيق على النتائج</button>
        </div>
        <div class="row-muted">ملاحظة: الصفوف المقفولة (locked=TRUE) سيتم تخطيها تلقائيًا.</div>
      </div>

      <!-- Last 10 -->
      <div class="full">
        <div class="sectionTitle">آخر 10 تسجيلات</div>
        <div style="overflow:auto;max-height:360px;border:1px solid #eee;border-radius:14px">
          <table>
            <thead>
              <tr>
                <th>الوقت</th>
                <th>Reg ID</th>
                <th>ولي الأمر</th>
                <th>الصندوق</th>
                <th>المتسابق</th>
                <th>المرحلة</th>
                <th>النوع</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="lastRows"></tbody>
          </table>
        </div>
      </div>

      <!-- Results + edit -->
      <div class="full">
        <div class="sectionTitle">النتائج الحالية (تعديل Status / Score + Percent + PDF)</div>
        <div style="overflow:auto;border:1px solid #eee;border-radius:14px">
          <table>
            <thead>
              <tr>
                <th>Reg ID</th>
                <th>المتسابق</th>
                <th>المرحلة</th>
                <th>النوع</th>
                <th>ولي الأمر</th>
                <th>الصندوق</th>
                <th>Status</th>
                <th>Score</th>
                <th>Percent</th>
                <th>Locked</th>
                <th>صور</th>
                <th>PDF</th>
                <th>حفظ</th>
              </tr>
            </thead>
            <tbody id="searchRows">
              <tr><td colspan="13" class="muted" style="text-align:center;padding:16px">اضغط "عرض كل المسجلين" أو ابدأ بالبحث…</td></tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyo4zs3v4Qno0j_p5N-8qV2WR-HFG63nlrWR-F773WKLjj3cnDAg94zu9vVOMYvTngJ/exec";

let CURRENT_MODE = ''; // 'all' | 'search'
let CURRENT_PAGE = 1;
let CURRENT_TOTAL = 0;
let LAST_ITEMS = [];   // آخر نتائج معروضة (للبلك)
let LAST_SEARCH_META = { field:'', q:'' };

function setMsg(t, ok){
  const m = document.getElementById('msg');
  m.textContent = t || '';
  m.className = 'msg ' + (ok ? 'ok' : 'err');
}

function saveKey(){
  const k = (document.getElementById('admin_key').value || '').trim();
  localStorage.setItem('QH_ADMIN_KEY', k);
  setMsg('تم حفظ المفتاح على هذا الجهاز ✅', true);
}

function loadSavedKey(){
  const k = localStorage.getItem('QH_ADMIN_KEY') || '';
  document.getElementById('admin_key').value = k;
}

function esc(s){
  return String(s || '').replace(/[&<>"']/g, c => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[c]));
}

function fillStats(data){
  document.getElementById('total_rows').textContent = data.total_rows ?? '0';
  document.getElementById('boys').textContent = data.boys ?? '0';
  document.getElementById('girls').textContent = data.girls ?? '0';
  document.getElementById('sum_bg').textContent =
    (Number(data.boys||0) + Number(data.girls||0)).toString();

  const st = data.by_stage || {};
  document.getElementById('st_KG').textContent = st.KG ?? '0';
  document.getElementById('st_Primary').textContent = st.Primary ?? '0';
  document.getElementById('st_Middle').textContent = st.Middle ?? '0';
  document.getElementById('st_Secondary').textContent = st.Secondary ?? '0';

  const tbody = document.getElementById('lastRows');
  tbody.innerHTML = '';
  const rows = Array.isArray(data.last) ? data.last : [];
  for(const r of rows){
    tbody.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${esc(r.created_at)}</td>
        <td><span class="pill">${esc(r.reg_id)}</span></td>
        <td>${esc(r.guardian_name)}<div class="row-muted">${esc(r.guardian_civil_id)}</div></td>
        <td>${esc(r.box_number)}</td>
        <td>${esc(r.child_name)}<div class="row-muted">${esc(r.child_civil_id)}</div></td>
        <td>${esc(r.stage)}</td>
        <td>${esc(r.gender)}</td>
        <td>${esc(r.status)}</td>
      </tr>
    `);
  }
}

function getAdminKeyOrWarn(){
  const admin_key = (document.getElementById('admin_key').value || '').trim();
  if(!admin_key){
    setMsg('اكتب Admin Key الأول.', false);
    return null;
  }
  return admin_key;
}

function getFilters(){
  return {
    stage: (document.getElementById('filter_stage').value || '').trim(),
    gender: (document.getElementById('filter_gender').value || '').trim(),
    pageSize: Number((document.getElementById('pageSize').value || '50').trim()) || 50
  };
}

async function postForm(params){
  const body = new URLSearchParams(params);
  const res = await fetch(API_URL, {
    method:'POST',
    headers: {"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},
    body
  });
  return await res.json();
}

function normalizeItems(data){
  // متسامح مع: items أو rows
  const items = Array.isArray(data?.items) ? data.items : (Array.isArray(data?.rows) ? data.rows : []);
  return items;
}

async function loadStats(){
  setMsg('', true);
  const admin_key = getAdminKeyOrWarn();
  if(!admin_key) return;

  try{
    const data = await postForm({ action:'getStats', admin_key });
    if(data && data.ok){
      fillStats(data);
      setMsg('تم تحديث الإحصائيات ✅', true);
      return;
    }
    setMsg((data && data.error) ? data.error : 'فشل تحميل البيانات', false);
  }catch(e){
    setMsg('حصل خطأ أثناء الاتصال. جرّب مرة أخرى.', false);
  }
}

async function exportCsv(){
  setMsg('', true);
  const admin_key = getAdminKeyOrWarn();
  if(!admin_key) return;

  try{
    const data = await postForm({ action:'exportCsv', admin_key });
    if(!(data && data.ok)){
      setMsg((data && data.error) ? data.error : 'فشل التصدير', false);
      return;
    }

    const csv = data.csv || '';
    const filename = data.filename || 'registrations.csv';

    const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);

    setMsg('تم تصدير الملف ✅', true);
  }catch(e){
    setMsg('حصل خطأ أثناء التصدير.', false);
  }
}

/** ===========================
 *  RENDER TABLE
 *  =========================== */
function fmtPercent(v){
  if(v === null || v === undefined || v === '') return '';
  const n = Number(v);
  if(isNaN(n)) return String(v);
  // لو جاي كسر 0.7 => 70%
  if(n <= 1) return Math.round(n*100) + '%';
  // لو جاي 70 => 70%
  return Math.round(n) + '%';
}

function isLockedVal(v){
  return String(v||'').trim().toUpperCase() === 'TRUE';
}

function renderResults(items, infoText){
  const tbody = document.getElementById('searchRows');
  LAST_ITEMS = Array.isArray(items) ? items : [];

  if(infoText){
    document.getElementById('searchInfo').textContent = infoText;
  }

  if(!LAST_ITEMS.length){
    tbody.innerHTML = `<tr><td colspan="13" class="muted" style="text-align:center;padding:16px">لا توجد نتائج.</td></tr>`;
    return;
  }

  tbody.innerHTML = '';
  for(const it of LAST_ITEMS){
    const rid = esc(it.reg_id);
    const status = esc(it.status);
    const score = (it.score === null || it.score === undefined) ? '' : esc(it.score);
    const percent = fmtPercent(it.percent);
    const locked = isLockedVal(it.locked);

    const lockBadge = locked ? `<span class="lockPill">LOCKED</span>` : `<span class="pill">OPEN</span>`;

    tbody.insertAdjacentHTML('beforeend', `
      <tr id="r_${rid}">
        <td><span class="pill">${rid}</span><div class="row-muted">#${esc(it.serial_no||'')}</div></td>
        <td>${esc(it.child_name||'')}<div class="row-muted">${esc(it.child_civil_id||'')}</div></td>
        <td>${esc(it.stage||'')}</td>
        <td>${esc(it.gender||'')}</td>
        <td>${esc(it.guardian_name||'')}<div class="row-muted">${esc(it.guardian_civil_id||'')}</div></td>
        <td>${esc(it.box_number||'')}</td>

        <td>
          <select id="st_${rid}" class="mini" ${locked?'disabled':''}>
            <option value="">(بدون تغيير)</option>
            <option value="REGISTERED">REGISTERED</option>
            <option value="PASSED">PASSED</option>
            <option value="FAILED">FAILED</option>
            <option value="SUBMITTED">SUBMITTED</option>
            <option value="ABSENT">ABSENT</option>
          </select>
          <div class="row-muted">الحالي: ${status || '-'}</div>
        </td>

        <td>
          <input id="sc_${rid}" class="mini" value="${score}" placeholder="Score" ${locked?'disabled':''} />
          <div class="row-muted">ملاحظة: لو MAX_SCORE مضبوط، الحالة وpercent هيتحسبوا تلقائيًا.</div>
        </td>

        <td><span class="pill">${esc(percent)}</span></td>
        <td>${lockBadge}</td>

        <td>
          ${it.guardian_id_image_url ? `<a class="linkBtn" target="_blank" href="${esc(it.guardian_id_image_url)}">بطاقة ولي الأمر</a>` : ''}
          ${it.child_id_image_url ? `<a class="linkBtn" target="_blank" href="${esc(it.child_id_image_url)}">بطاقة المتسابق</a>` : ''}
        </td>

        <td>
          <button class="btn-mini btn-dark" type="button" onclick="printCard('${rid}')" ${locked?'':'style="opacity:1"'}>PDF</button>
        </td>

        <td>
          <button class="btn-mini" type="button" onclick="saveRow('${rid}')" ${locked?'disabled':''}>حفظ</button>
          <div class="row-muted" id="m_${rid}">${locked ? 'مقفول (LOCKED)' : ''}</div>
        </td>
      </tr>
    `);

    // اضبط الدروب داون على “بدون تغيير”
    const sel = document.getElementById('st_' + (it.reg_id||''));
    if(sel) sel.value = '';
  }
}

/** ===========================
 *  VIEW ALL (listAll)
 *  =========================== */
async function loadAll(page){
  setMsg('', true);
  const admin_key = getAdminKeyOrWarn();
  if(!admin_key) return;

  const f = getFilters();
  CURRENT_MODE = 'all';
  CURRENT_PAGE = Math.max(Number(page||1), 1);

  document.getElementById('allInfo').textContent = 'جاري تحميل كل المسجلين...';
  const tbody = document.getElementById('searchRows');
  tbody.innerHTML = `<tr><td colspan="13" class="muted" style="text-align:center;padding:16px">جاري التحميل...</td></tr>`;

  try{
    const data = await postForm({
      action:'listAll',
      admin_key,
      page: CURRENT_PAGE,
      pageSize: f.pageSize,
      stage: f.stage,
      gender: f.gender
    });

    if(!(data && data.ok)){
      setMsg((data && data.error) ? data.error : 'فشل تحميل الكل', false);
      document.getElementById('allInfo').textContent = '';
      document.getElementById('pager').style.display = 'none';
      return;
    }

    const items = normalizeItems(data);
    CURRENT_TOTAL = Number(data.total || data.total_rows || 0);

    const info = `عرض صفحة ${CURRENT_PAGE} — (PageSize: ${f.pageSize}) — إجمالي الصفوف: ${CURRENT_TOTAL}`;
    document.getElementById('allInfo').textContent = info;

    // pager
    const canPrev = CURRENT_PAGE > 1;
    const maxPage = f.pageSize > 0 ? Math.ceil((CURRENT_TOTAL||0) / f.pageSize) : 1;
    const canNext = CURRENT_PAGE < maxPage;

    const pager = document.getElementById('pager');
    pager.style.display = (maxPage > 1) ? 'flex' : 'none';
    pager.querySelectorAll('button')[0].disabled = !canPrev;
    pager.querySelectorAll('button')[1].disabled = !canNext;

    renderResults(items, '');

  }catch(e){
    setMsg('حصل خطأ أثناء التحميل.', false);
    document.getElementById('allInfo').textContent = '';
    document.getElementById('pager').style.display = 'none';
  }
}

function prevPage(){ loadAll(CURRENT_PAGE - 1); }
function nextPage(){ loadAll(CURRENT_PAGE + 1); }

/** ===========================
 *  SEARCH
 *  =========================== */
async function doSearch(){
  setMsg('', true);
  const admin_key = getAdminKeyOrWarn();
  if(!admin_key) return;

  const field = (document.getElementById('search_field').value || '').trim();
  const q = (document.getElementById('search_q').value || '').trim();
  if(!q){
    setMsg('اكتب قيمة البحث.', false);
    return;
  }

  const f = getFilters();
  CURRENT_MODE = 'search';
  LAST_SEARCH_META = { field, q };

  document.getElementById('searchInfo').textContent = 'جاري البحث...';
  const tbody = document.getElementById('searchRows');
  tbody.innerHTML = `<tr><td colspan="13" class="muted" style="text-align:center;padding:16px">جاري التحميل...</td></tr>`;

  try{
    // ملاحظة: backend الجديد الأفضل يستخدم q فقط
    // لكن لو عندك نسخة قديمة تعتمد field/q هنرسلهم الاثنين
    const data = await postForm({
      action:'search',
      admin_key,
      field,
      q,
      stage: f.stage,
      gender: f.gender
    });

    if(!(data && data.ok)){
      setMsg((data && data.error) ? data.error : 'فشل البحث', false);
      document.getElementById('searchInfo').textContent = '';
      return;
    }

    const items = normalizeItems(data);
    document.getElementById('searchInfo').textContent = `عدد النتائج: ${items.length}`;
    renderResults(items, `عدد النتائج: ${items.length}`);

  }catch(e){
    setMsg('حصل خطأ أثناء البحث.', false);
    document.getElementById('searchInfo').textContent = '';
  }
}

/** ===========================
 *  SAVE ROW (updateResult)
 *  =========================== */
async function saveRow(reg_id){
  setMsg('', true);
  const admin_key = getAdminKeyOrWarn();
  if(!admin_key) return;

  const msgEl = document.getElementById('m_' + reg_id);
  if(msgEl) msgEl.textContent = '...';

  const status = (document.getElementById('st_' + reg_id)?.value || '').trim();
  const score = (document.getElementById('sc_' + reg_id)?.value || '').trim();

  try{
    const data = await postForm({
      action:'updateResult',
      admin_key,
      reg_id,
      status, // backend ممكن يتجاهله لو MAX_SCORE مضبوط وscore موجود
      score
    });

    if(data && data.ok){
      if(msgEl) msgEl.textContent = 'تم ✅';

      // حدّث الإحصائيات
      loadStats();

      // أعِد تحميل نفس الشاشة علشان يظهر percent/locked لو اتغيروا
      if(CURRENT_MODE === 'all') loadAll(CURRENT_PAGE);
      else if(CURRENT_MODE === 'search') doSearch();

      return;
    }

    if(msgEl) msgEl.textContent = (data && data.error) ? data.error : 'فشل';
  }catch(e){
    if(msgEl) msgEl.textContent = 'خطأ اتصال';
  }
}

/** ===========================
 *  BULK UPDATE STATUS
 *  =========================== */
async function bulkApply(){
  setMsg('', true);
  const admin_key = getAdminKeyOrWarn();
  if(!admin_key) return;

  const new_status = (document.getElementById('bulk_status').value || '').trim();
  if(!new_status){
    setMsg('اختر الحالة الجديدة أولاً.', false);
    return;
  }

  if(!Array.isArray(LAST_ITEMS) || !LAST_ITEMS.length){
    setMsg('لا توجد نتائج حالية لتطبيق التغيير عليها.', false);
    return;
  }

  const reg_ids = LAST_ITEMS.map(x => x.reg_id).filter(Boolean);

  try{
    const data = await postForm({
      action:'bulkUpdateStatus',
      admin_key,
      new_status,
      reg_ids: JSON.stringify(reg_ids)
    });

    if(data && data.ok){
      setMsg(`تم تحديث: ${data.updated} | تم تخطي (locked): ${data.skipped_locked}`, true);
      loadStats();
      if(CURRENT_MODE === 'all') loadAll(CURRENT_PAGE);
      else if(CURRENT_MODE === 'search') doSearch();
      return;
    }

    setMsg((data && data.error) ? data.error : 'فشل التحديث الجماعي', false);
  }catch(e){
    setMsg('حصل خطأ أثناء التحديث الجماعي.', false);
  }
}

/** ===========================
 *  PRINT CARD PDF
 *  =========================== */
async function printCard(reg_id){
  setMsg('جاري إنشاء PDF ...', true);

  const admin_key = getAdminKeyOrWarn();
  if(!admin_key) return;

  try{
    const data = await postForm({
      action: 'cardPdf',   // خليها cardPdf مؤقتًا (هنثبتها بعد ما نراجع doPost)
      admin_key,
      reg_id
    });

    // ✅ اعرض الرد كله لو فيه مشكلة
    if(!data){
      setMsg('لم يصل رد من السيرفر.', false);
      return;
    }

    if(!data.ok){
      setMsg('خطأ من السيرفر: ' + (data.error || JSON.stringify(data)), false);
      return;
    }

    const url = data.pdf_url || data.url;
    if(!url){
      setMsg('السيرفر قال OK لكن لم يرجع رابط PDF: ' + JSON.stringify(data), false);
      return;
    }

    setMsg('تم إنشاء PDF ✅ جاري الفتح...', true);
    window.location.href = url;

  }catch(e){
    setMsg('خطأ أثناء الاتصال: ' + (e && e.message ? e.message : e), false);
  }
}
loadSavedKey();

 async function printAllGuardiansPdf(){
  setMsg('', true);
  const admin_key = getAdminKeyOrWarn();
  if(!admin_key) return;

  try{
    const data = await postForm({
      action:'guardiansPdf',
      admin_key
      // تقدر تبعت stage/gender/status هنا لو عايز كشف مفلتر
      // stage: document.getElementById('filter_stage').value,
      // gender: document.getElementById('filter_gender').value,
    });

    if(data && data.ok && data.url){
      window.open(data.url, '_blank');
      setMsg('تم إنشاء كشف PDF ✅', true);
      return;
    }
    setMsg((data && data.error) ? data.error : 'فشل إنشاء كشف PDF', false);
  }catch(e){
    setMsg('حصل خطأ أثناء إنشاء كشف PDF.', false);
  }
}
</script>
</body>
</html>
