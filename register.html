<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>تسجيل المتسابقين</title>
<style>
  *{box-sizing:border-box}
  body{font-family:Arial,sans-serif;background:#f6f7fb;margin:0;padding:24px}
  .wrap{max-width:900px;margin:0 auto}
  .card{background:#fff;border-radius:16px;padding:22px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
  h2{margin:0 0 14px;text-align:center}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  label{display:block;margin:10px 0 6px;font-weight:700}
  input,select{width:100%;padding:11px;border:1px solid #d8d8d8;border-radius:10px}
  .full{grid-column:1/-1}
  button{
    width:100%;margin-top:14px;padding:14px 16px;border:0;border-radius:12px;
    background:#2e7d32;color:#fff;font-size:16px;cursor:pointer
  }
  button:hover{background:#256628}
  .btn-secondary{background:#6c63ff}
  .btn-secondary:hover{background:#5a52df}
  .danger{background:#c62828}
  .danger:hover{background:#a32020}
  .muted{color:#666;text-align:center;margin:10px 0 0}
  .child-card{border:1px solid #eee;border-radius:14px;padding:14px;margin-top:12px;background:#fafafa}
  .child-head{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .child-head h3{margin:0;font-size:16px}
  .msg{margin-top:12px;text-align:center;font-weight:700}
  .err{color:#b00020}
  .ok{color:#1b5e20}
  .hint{font-size:12px;color:#666;margin-top:6px}
  .hint.bad{color:#b00020;font-weight:700}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h2>تسجيل المتسابقين</h2>

    <div class="grid">
      <div>
        <label>اسم ولي الأمر</label>
        <input id="guardian_name" placeholder="مثال: محمد أحمد" />
      </div>

      <div>
        <label>الرقم المدني (ولي الأمر)</label>
        <input id="guardian_civil_id" inputmode="numeric" placeholder="رقم مدني" />
      </div>

      <div>
        <label>رقم الصندوق</label>
        <input id="box_number" inputmode="numeric" placeholder="رقم الصندوق" />
      </div>

      <div>
        <label>صورة البطاقة المدنية (ولي الأمر)</label>
        <input id="guardian_id_img" type="file" accept="image/*" onchange="showFileSize(this, 'guardian_size')" />
        <div class="hint" id="guardian_size">لم يتم اختيار صورة بعد</div>
      </div>

      <div class="full">
        <button class="btn-secondary" type="button" onclick="addChild()">+ إضافة ابن/ابنة</button>
      </div>

      <div class="full" id="childrenWrap"></div>

      <div class="full">
        <button id="submitBtn" type="button" onclick="submitAll()">إرسال التسجيل</button>
        <div class="msg" id="msg"></div>
        <p class="muted">ملاحظة: كل ابن/ابنة = صف مستقل في قاعدة البيانات.</p>
      </div>
    </div>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyo4zs3v4Qno0j_p5N-8qV2WR-HFG63nlrWR-F773WKLjj3cnDAg94zu9vVOMYvTngJ/exec";
let childIndex = 0;
let IS_BUSY = false;

function digits(x){ return String(x||"").replace(/\D+/g,""); }

function getQS(){
  const q = new URLSearchParams(window.location.search);
  return {
    guardian_civil_id: digits(q.get('guardian_civil_id')||""),
    box_number: digits(q.get('box_number')||""),
    guardian_name: (q.get('guardian_name')||"").trim()
  };
}

function childTemplate(i){
  return `
    <div class="child-card" id="child_${i}">
      <div class="child-head">
        <h3>بيانات المتسابق #${i+1}</h3>
        <button class="danger" type="button" onclick="removeChild(${i})">حذف</button>
      </div>

      <div class="grid" style="margin-top:10px">
        <div>
          <label>اسم المتسابق</label>
          <input id="child_name_${i}" placeholder="اسم الابن/الابنة" />
        </div>

        <div>
          <label>الرقم المدني (المتسابق)</label>
          <input id="child_civil_id_${i}" inputmode="numeric" placeholder="رقم مدني" />
        </div>

        <div>
          <label>النوع</label>
          <select id="gender_${i}">
            <option value="">اختر</option>
            <option value="Boys">بنين</option>
            <option value="Girls">بنات</option>
          </select>
        </div>

        <div>
          <label>المرحلة</label>
          <select id="stage_${i}">
            <option value="">اختر</option>
            <option value="KG">الروضة</option>
            <option value="Primary">الابتدائي</option>
            <option value="Middle">المتوسط</option>
            <option value="Secondary">الثانوي</option>
          </select>
        </div>

        <div class="full">
          <label>صورة البطاقة المدنية (المتسابق)</label>
          <input id="child_id_img_${i}" type="file" accept="image/*" onchange="showFileSize(this, 'child_size_${i}')" />
          <div class="hint" id="child_size_${i}">لم يتم اختيار صورة بعد</div>
        </div>
      </div>
    </div>
  `;
}

function addChild(){
  const wrap = document.getElementById('childrenWrap');
  wrap.insertAdjacentHTML('beforeend', childTemplate(childIndex));
  childIndex++;
  refreshSubmitState();
}

function removeChild(i){
  const el = document.getElementById('child_' + i);
  if(el) el.remove();
  refreshSubmitState();
}

function readAsDataURL_(blob){
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(String(r.result || ''));
    r.onerror = reject;
    r.readAsDataURL(blob);
  });
}

function loadImage_(file){
  return new Promise((resolve, reject) => {
    const url = URL.createObjectURL(file);
    const img = new Image();
    img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
    img.onerror = (e) => { URL.revokeObjectURL(url); reject(e); };
    img.src = url;
  });
}

function canvasCompress_(img, maxDim, quality){
  return new Promise((resolve) => {
    let { width, height } = img;

    const scale = Math.min(1, maxDim / Math.max(width, height));
    width = Math.round(width * scale);
    height = Math.round(height * scale);

    const canvas = document.createElement('canvas');
    canvas.width = width;
    canvas.height = height;

    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, width, height);

    canvas.toBlob((blob) => {
      resolve(blob || new Blob([], {type:'image/jpeg'}));
    }, 'image/jpeg', quality);
  });
}

async function compressImageToUnderLimit_(file, maxBytes){
  const img = await loadImage_(file);

  let maxDim = 1600;
  let quality = 0.82;
  let blob = await canvasCompress_(img, maxDim, quality);

  while(blob.size > maxBytes && quality > 0.45){
    quality -= 0.08;
    blob = await canvasCompress_(img, maxDim, quality);
  }

  while(blob.size > maxBytes && maxDim > 900){
    maxDim -= 200;
    quality = Math.max(0.5, quality);
    blob = await canvasCompress_(img, maxDim, quality);
  }

  return blob;
}

async function fileToDataUrl(file){
  const MAX_SIZE = 3 * 1024 * 1024;

  if(!file) throw new Error("لم يتم اختيار صورة.");
  if(!String(file.type || '').startsWith('image/')) throw new Error("الملف المختار لازم يكون صورة.");

  if(file.size <= MAX_SIZE){
    return await readAsDataURL_(file);
  }

  const compressedBlob = await compressImageToUnderLimit_(file, MAX_SIZE);

  if(compressedBlob.size > MAX_SIZE){
    throw new Error("تعذر ضغط الصورة تحت 3 ميجا. جرّب صورة أوضح/أقل حجمًا.");
  }

  return await readAsDataURL_(compressedBlob);
}

function setMsg(text, ok){
  const m = document.getElementById('msg');
  m.textContent = text;
  m.className = 'msg ' + (ok ? 'ok' : 'err');
}

/* ✅ إضافة setBusy الصحيحة بدل السطر المكسور "setBusy" */
function setBusy(v){
  IS_BUSY = !!v;
  refreshSubmitState();
}

/* ✅ مهم: رجوع fail كما هو لكن يعتمد على setBusy */
function fail(message){
  setMsg(message, false);
  setBusy(false);
  return;
}

(function init(){
  const qs = getQS();

  // ✅ لو الصفحة اتفتحت بدون رقم ولي الأمر أو رقم الصندوق → ارجع لصفحة التحقق
  if(!qs.guardian_civil_id || qs.guardian_civil_id.length < 8 || !qs.box_number || qs.box_number.length < 1){
    alert('من فضلك ادخل من صفحة التحقق أولاً.');
    window.location.href = 'index.html';
    return;
  }

  // ✅ تعبئة البيانات تلقائياً
  document.getElementById('guardian_civil_id').value = qs.guardian_civil_id;
  document.getElementById('box_number').value = qs.box_number;
  if(qs.guardian_name) document.getElementById('guardian_name').value = qs.guardian_name;

  // ✅ جعل الرقم المدني ورقم الصندوق للعرض فقط (اختياري لكنه يمنع اللخبطة)
  document.getElementById('guardian_civil_id').readOnly = true;
  document.getElementById('box_number').readOnly = true;

  // ✅ إضافة متسابق افتراضي تلقائياً عند فتح الصفحة
  addChild();
})();

function formatBytes(bytes){
  const mb = bytes / (1024 * 1024);
  return mb.toFixed(2) + " MB";
}

const MAX_SIZE = 3 * 1024 * 1024;

/**
 * ✅ مهم: زر الإرسال يتقفل فقط أثناء الإرسال
 */
function refreshSubmitState(){
  const btn = document.getElementById('submitBtn');
  if(!btn) return;

  btn.disabled = !!IS_BUSY;
  btn.style.opacity = btn.disabled ? "0.7" : "1";
  btn.style.cursor = btn.disabled ? "not-allowed" : "pointer";
}

function showFileSize(input, labelId){
  const el = document.getElementById(labelId);
  const file = input && input.files ? input.files[0] : null;

  if(!el) return;

  if(!file){
    el.textContent = "لم يتم اختيار صورة بعد";
    el.className = "hint";
    refreshSubmitState();
    return;
  }

  const sizeText = formatBytes(file.size);

  if(file.size > MAX_SIZE){
    el.textContent = `حجم الصورة: ${sizeText} — سيتم ضغطها تلقائيًا قبل الإرسال ✅`;
    el.className = "hint";
  }else{
    el.textContent = `حجم الصورة: ${sizeText} ✅`;
    el.className = "hint";
  }

  refreshSubmitState();
}

async function submitAll(){
  setBusy(true);

  try{
    const guardian_name = document.getElementById('guardian_name').value.trim();
    const guardian_civil_id = digits(document.getElementById('guardian_civil_id').value);
    const box_number = digits(document.getElementById('box_number').value);

    const guardianFile = document.getElementById('guardian_id_img').files[0];
    if(!guardianFile) return fail("صورة بطاقة ولي الأمر مطلوبة.");

    const children = [];

    for(let i=0;i<childIndex;i++){
      const card = document.getElementById('child_' + i);
      if(!card) continue;

      const child_name = (document.getElementById('child_name_' + i).value || '').trim();
      const child_civil_id = digits(document.getElementById('child_civil_id_' + i).value);
      const gender = (document.getElementById('gender_' + i).value || '').trim();
      const stage = (document.getElementById('stage_' + i).value || '').trim();
      const childFile = document.getElementById('child_id_img_' + i).files[0];

      if(!child_name || child_civil_id.length < 8 || !gender || !stage || !childFile){
        return fail(`تأكد من بيانات المتسابق #${i+1} وصورته.`);
      }

      let child_id_image_base64;
      try{
        child_id_image_base64 = await fileToDataUrl(childFile);
      }catch(err){
        return fail(err.message + ` (المتسابق #${i+1})`);
      }

      children.push({ child_name, child_civil_id, gender, stage, child_id_image_base64 });
    }

    if(!children.length){
      return fail("أضف متسابق واحد على الأقل.");
    }

    let guardian_id_image_base64;
    try{
      guardian_id_image_base64 = await fileToDataUrl(guardianFile);
    }catch(err){
      return fail(err.message);
    }

    const body = new URLSearchParams({
      action: "register",
      guardian_name,
      guardian_civil_id,
      box_number,
      guardian_id_image_base64,
      children: JSON.stringify(children)
    });

    const res = await fetch(API_URL, {
      method:"POST",
      headers: {"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},
      body
    });

    const data = await res.json();

    if(data && data.ok){
      const items = encodeURIComponent(JSON.stringify(data.items || []));
      window.location.href = "success.html?items=" + items;
      return;
    }

    return fail((data && data.error) ? data.error : "فشل التسجيل.");

  }catch(e){
    return fail("حصل خطأ أثناء الإرسال. جرّب مرة أخرى.");
  } finally {
    setBusy(false);
  }
}
</script>
</body>
</html>
