<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ†</title>
<style>
  *{box-sizing:border-box}
  body{font-family:Arial,sans-serif;background:#f6f7fb;margin:0;padding:24px}
  .wrap{max-width:900px;margin:0 auto}
  .card{background:#fff;border-radius:16px;padding:22px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
  h2{margin:0 0 14px;text-align:center}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  label{display:block;margin:10px 0 6px;font-weight:700}
  input,select{width:100%;padding:11px;border:1px solid #d8d8d8;border-radius:10px}
  .full{grid-column:1/-1}
  button{
    width:100%;margin-top:14px;padding:14px 16px;border:0;border-radius:12px;
    background:#2e7d32;color:#fff;font-size:16px;cursor:pointer
  }
  button:hover{background:#256628}
  .btn-secondary{background:#6c63ff}
  .btn-secondary:hover{background:#5a52df}
  .danger{background:#c62828}
  .danger:hover{background:#a32020}
  .muted{color:#666;text-align:center;margin:10px 0 0}
  .child-card{border:1px solid #eee;border-radius:14px;padding:14px;margin-top:12px;background:#fafafa}
  .child-head{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .child-head h3{margin:0;font-size:16px}
  .msg{margin-top:12px;text-align:center;font-weight:700}
  .err{color:#b00020}
  .ok{color:#1b5e20}
 .hint{font-size:12px;color:#666;margin-top:6px}
.hint.bad{color:#b00020;font-weight:700}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ†</h2>

    <div class="grid">
      <div>
        <label>Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</label>
        <input id="guardian_name" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯" />
      </div>

      <div>
        <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ (ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±)</label>
        <input id="guardian_civil_id" inputmode="numeric" placeholder="Ø±Ù‚Ù… Ù…Ø¯Ù†ÙŠ" />
      </div>

      <div>
        <label>Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</label>
        <input id="box_number" inputmode="numeric" placeholder="Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚" />
      </div>

      <div>
        <label>ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø¯Ù†ÙŠØ© (ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±)</label>
        <input id="guardian_id_img" type="file" accept="image/*" onchange="showFileSize(this, 'guardian_size')" />
<div class="hint" id="guardian_size">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø¨Ø¹Ø¯</div>

      </div>

      <div class="full">
        <button class="btn-secondary" type="button" onclick="addChild()">+ Ø¥Ø¶Ø§ÙØ© Ø§Ø¨Ù†/Ø§Ø¨Ù†Ø©</button>
      </div>

      <div class="full" id="childrenWrap"></div>

      <div class="full">
        <button id="submitBtn" type="button" onclick="submitAll()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
        <div class="msg" id="msg"></div>
        <p class="muted">Ù…Ù„Ø§Ø­Ø¸Ø©: ÙƒÙ„ Ø§Ø¨Ù†/Ø§Ø¨Ù†Ø© = ØµÙ Ù…Ø³ØªÙ‚Ù„ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>
      </div>
    </div>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyo4zs3v4Qno0j_p5N-8qV2WR-HFG63nlrWR-F773WKLjj3cnDAg94zu9vVOMYvTngJ/exec";
let childIndex = 0;

function digits(x){ return String(x||"").replace(/\D+/g,""); }

function getQS(){
  const q = new URLSearchParams(window.location.search);
  return {
    guardian_civil_id: digits(q.get('guardian_civil_id')||""),
    box_number: digits(q.get('box_number')||""),
    guardian_name: (q.get('guardian_name')||"").trim()
  };
}

function childTemplate(i){
  return `
    <div class="child-card" id="child_${i}">
      <div class="child-head">
        <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ #${i+1}</h3>
        <button class="danger" type="button" onclick="removeChild(${i})">Ø­Ø°Ù</button>
      </div>

      <div class="grid" style="margin-top:10px">
        <div>
          <label>Ø§Ø³Ù… Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚</label>
          <input id="child_name_${i}" placeholder="Ø§Ø³Ù… Ø§Ù„Ø§Ø¨Ù†/Ø§Ù„Ø§Ø¨Ù†Ø©" />
        </div>

        <div>
          <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ (Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚)</label>
          <input id="child_civil_id_${i}" inputmode="numeric" placeholder="Ø±Ù‚Ù… Ù…Ø¯Ù†ÙŠ" />
        </div>

        <div>
          <label>Ø§Ù„Ù†ÙˆØ¹</label>
          <select id="gender_${i}">
            <option value="">Ø§Ø®ØªØ±</option>
            <option value="Boys">Ø¨Ù†ÙŠÙ†</option>
            <option value="Girls">Ø¨Ù†Ø§Øª</option>
          </select>
        </div>

        <div>
          <label>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</label>
          <select id="stage_${i}">
            <option value="">Ø§Ø®ØªØ±</option>
            <option value="KG">Ø§Ù„Ø±ÙˆØ¶Ø©</option>
            <option value="Primary">Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
            <option value="Middle">Ø§Ù„Ù…ØªÙˆØ³Ø·</option>
            <option value="Secondary">Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
          </select>
        </div>

        <div class="full">
          <label>ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø¯Ù†ÙŠØ© (Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚)</label>
          <input id="child_id_img_${i}" type="file" accept="image/*" onchange="showFileSize(this, 'child_size_${i}')" />
<div class="hint" id="child_size_${i}">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø¨Ø¹Ø¯</div>

        </div>
      </div>
    </div>
  `;
}

function addChild(){
  const wrap = document.getElementById('childrenWrap');
  wrap.insertAdjacentHTML('beforeend', childTemplate(childIndex));
  childIndex++;
 refreshSubmitState();
}

function removeChild(i){
  const el = document.getElementById('child_' + i);
  if(el) el.remove();
 refreshSubmitState();
}

async function fileToDataUrl(file){
  const MAX_SIZE = 3 * 1024 * 1024; // 3MB

  if(!file) throw new Error("Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©.");
  if(!String(file.type || '').startsWith('image/')) throw new Error("Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø®ØªØ§Ø± Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† ØµÙˆØ±Ø©.");

  // Ù„Ùˆ ØµØºÙŠØ±Ø©ØŒ Ø±Ø¬Ù‘Ø¹Ù‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¯ÙˆÙ† Ø¶ØºØ·
  if(file.size <= MAX_SIZE){
    return await readAsDataURL_(file);
  }

  // Ù„Ùˆ ÙƒØ¨ÙŠØ±Ø©: Ø§Ø¶ØºØ·Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
  const compressedBlob = await compressImageToUnderLimit_(file, MAX_SIZE);

  // (Ù„Ùˆ Ù…Ø§Ù‚Ø¯Ø±Ø´ ÙŠÙ†Ø²Ù„Ù‡Ø§ ØªØ­Øª Ø§Ù„Ø­Ø¯ Ù„Ø£ÙŠ Ø³Ø¨Ø¨)
  if(compressedBlob.size > MAX_SIZE){
    throw new Error("ØªØ¹Ø°Ø± Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© ØªØ­Øª 3 Ù…ÙŠØ¬Ø§. Ø¬Ø±Ù‘Ø¨ ØµÙˆØ±Ø© Ø£ÙˆØ¶Ø­/Ø£Ù‚Ù„ Ø­Ø¬Ù…Ù‹Ø§.");
  }

  return await readAsDataURL_(compressedBlob);
}

function readAsDataURL_(blob){
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(String(r.result || ''));
    r.onerror = reject;
    r.readAsDataURL(blob);
  });
}

async function compressImageToUnderLimit_(file, maxBytes){
  // Ù†Ù‚Ø±Ø£ Ø§Ù„ØµÙˆØ±Ø© ÙƒÙ€ Image
  const img = await loadImage_(file);

  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¶ØºØ· (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)
  let maxDim = 1600;     // Ø£Ù‚ØµÙ‰ Ø¨ÙØ¹Ø¯ (Ø¹Ø±Ø¶/Ø§Ø±ØªÙØ§Ø¹)
  let quality = 0.82;    // Ø¬ÙˆØ¯Ø© JPEG
  let blob = await canvasCompress_(img, maxDim, quality);

  // Ù„Ùˆ Ù„Ø³Ù‡ ÙƒØ¨ÙŠØ±Ø©: Ù‚Ù„Ù„ Ø§Ù„Ø¬ÙˆØ¯Ø© ØªØ¯Ø±ÙŠØ¬ÙŠÙ‹Ø§
  while(blob.size > maxBytes && quality > 0.45){
    quality -= 0.08;
    blob = await canvasCompress_(img, maxDim, quality);
  }

  // Ù„Ùˆ Ù„Ø³Ù‡ ÙƒØ¨ÙŠØ±Ø©: ØµØºÙ‘Ø± Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ ØªØ¯Ø±ÙŠØ¬ÙŠÙ‹Ø§ + Ø²ÙˆÙ‘Ø¯ Ø¶ØºØ·
  while(blob.size > maxBytes && maxDim > 900){
    maxDim -= 200;
    quality = Math.max(0.5, quality); // Ø®Ù„ÙŠÙƒ ÙÙŠ Ø¬ÙˆØ¯Ø© Ù…Ø¹Ù‚ÙˆÙ„Ø©
    blob = await canvasCompress_(img, maxDim, quality);
  }

  return blob;
}

function loadImage_(file){
  return new Promise((resolve, reject) => {
    const url = URL.createObjectURL(file);
    const img = new Image();
    img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
    img.onerror = (e) => { URL.revokeObjectURL(url); reject(e); };
    img.src = url;
  });
}

function canvasCompress_(img, maxDim, quality){
  return new Promise((resolve) => {
    let { width, height } = img;

    // Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø¨Ø©
    const scale = Math.min(1, maxDim / Math.max(width, height));
    width = Math.round(width * scale);
    height = Math.round(height * scale);

    const canvas = document.createElement('canvas');
    canvas.width = width;
    canvas.height = height;

    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, width, height);

    // Ù†Ø­ÙˆÙ„ Ø¥Ù„Ù‰ JPEG Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø¬Ù…
    canvas.toBlob((blob) => {
      resolve(blob || file);
    }, 'image/jpeg', quality);
  });
}


function setMsg(text, ok){
  const m = document.getElementById('msg');
  m.textContent = text;
  m.className = 'msg ' + (ok ? 'ok' : 'err');
}

function setBusy(isBusy){
  const btn = document.getElementById('submitBtn');
  btn.disabled = isBusy;
  btn.textContent = isBusy ? "Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„..." : "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„";
}

function fail(message){
  setMsg(message, false);
  setBusy(false);
  return;
}

(async function init(){
  const qs = getQS();
  if(qs.guardian_civil_id) document.getElementById('guardian_civil_id').value = qs.guardian_civil_id;
  if(qs.box_number) document.getElementById('box_number').value = qs.box_number;
  if(qs.guardian_name) document.getElementById('guardian_name').value = qs.guardian_name;
  addChild(); // Ø§Ø¨Ø¯Ø£ Ø¨Ù…ØªØ³Ø§Ø¨Ù‚ ÙˆØ§Ø­Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
})();

 function formatBytes(bytes){
  const mb = bytes / (1024 * 1024);
  return mb.toFixed(2) + " MB";
}
const MAX_SIZE = 3 * 1024 * 1024;

function refreshSubmitState(){
  const btn = document.getElementById('submitBtn');
  if(!btn) return;

  let ok = true;

  // ØµÙˆØ±Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±
  const gFile = document.getElementById('guardian_id_img')?.files?.[0];
  if(gFile && gFile.size > MAX_SIZE) ok = false;

  // ØµÙˆØ± Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡
  for(let i=0;i<childIndex;i++){
    const card = document.getElementById('child_' + i);
    if(!card) continue;

    const cFile = document.getElementById('child_id_img_' + i)?.files?.[0];
    if(cFile && cFile.size > MAX_SIZE) ok = false;
  }

  btn.disabled = !ok;
  btn.style.opacity = ok ? "1" : "0.6";
  btn.style.cursor = ok ? "pointer" : "not-allowed";
}

function showFileSize(input, labelId){
  const el = document.getElementById(labelId);
  const file = input && input.files ? input.files[0] : null;

  if(!el) return;

  if(!file){
    el.textContent = "Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø¨Ø¹Ø¯";
    el.className = "hint";
    refreshSubmitState();   // ğŸ‘ˆ Ù…Ù‡Ù…
    return;
  }

  const sizeText = formatBytes(file.size);

if(file.size > MAX_SIZE){
  el.textContent = `Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø©: ${sizeText} â€” Ø³ÙŠØªÙ… Ø¶ØºØ·Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ âœ…`;
  el.className = "hint";
}else{
  el.textContent = `Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø©: ${sizeText} âœ…`;
  el.className = "hint";
}


  refreshSubmitState();   // ğŸ‘ˆ Ù…Ù‡Ù…
}
 
async function submitAll(){
  setBusy(true);

  try{
    const guardian_name = document.getElementById('guardian_name').value.trim();
    const guardian_civil_id = digits(document.getElementById('guardian_civil_id').value);
    const box_number = digits(document.getElementById('box_number').value);

    const guardianFile = document.getElementById('guardian_id_img').files[0];
    if(!guardianFile) return fail("ØµÙˆØ±Ø© Ø¨Ø·Ø§Ù‚Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ù…Ø·Ù„ÙˆØ¨Ø©.");

    // Ø§Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† (Ø­ØªÙ‰ Ù„Ùˆ Ø­ØµÙ„ Ø­Ø°Ù)
    const children = [];

    for(let i=0;i<childIndex;i++){
      const card = document.getElementById('child_' + i);
      if(!card) continue;

      const child_name = (document.getElementById('child_name_' + i).value || '').trim();
      const child_civil_id = digits(document.getElementById('child_civil_id_' + i).value);
      const gender = (document.getElementById('gender_' + i).value || '').trim();
      const stage = (document.getElementById('stage_' + i).value || '').trim();
      const childFile = document.getElementById('child_id_img_' + i).files[0];

      if(!child_name || child_civil_id.length < 8 || !gender || !stage || !childFile){
        return fail(`ØªØ£ÙƒØ¯ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ #${i+1} ÙˆØµÙˆØ±ØªÙ‡.`);
      }

      let child_id_image_base64;
      try{
        child_id_image_base64 = await fileToDataUrl(childFile);
      }catch(err){
        return fail(err.message + ` (Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ #${i+1})`);
      }

      children.push({ child_name, child_civil_id, gender, stage, child_id_image_base64 });
    }

    if(!children.length){
      return fail("Ø£Ø¶Ù Ù…ØªØ³Ø§Ø¨Ù‚ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");
    }

    let guardian_id_image_base64;
    try{
      guardian_id_image_base64 = await fileToDataUrl(guardianFile);
    }catch(err){
      return fail(err.message);
    }

    const payload = {
      action: "register",
      guardian_name,
      guardian_civil_id,
      box_number,
      guardian_id_image_base64,
      children
    };

   const body = new URLSearchParams({
  action: "register",
  guardian_name,
  guardian_civil_id,
  box_number,
  guardian_id_image_base64,
  children: JSON.stringify(children)
});

const res = await fetch(API_URL, {
  method:"POST",
  headers: {"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},
  body
});


    const data = await res.json();

    if(data && data.ok){
      const items = encodeURIComponent(JSON.stringify(data.items || []));
      window.location.href = "success.html?items=" + items;
      return;
    }

    return fail((data && data.error) ? data.error : "ÙØ´Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„.");

  }catch(e){
    return fail("Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„. Ø¬Ø±Ù‘Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
  }
}
</script>
</body>
</html>
